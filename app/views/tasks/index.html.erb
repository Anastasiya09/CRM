<div class="row">
  <div class="col-md-12 col-sm-12 col-xs-12">

    <div class="notifier pull-right">
      <div class="notice-mess">       
      </div>
      <div class="helper">
      </div>
    </div>

    <table class="table table-striped table-bordered table-condensed table-responsive">
      <thead>
        <tr class="info">
          <th>№</th>
          <th>Name</th>
          <th>Source</th>
          <th>Skype</th>
          <th>Email</th>
          <th>Message</th>
          <th>Links</th>
          <th>Date</th>
          <th>Assign to</th>
          <th>Status</th>
          <% if params[:only] == 'sold' %>
            <th>Price</th>
            <th>Terms</th>
          <% end %>
          <th>Comments</th>
        </tr>
      </thead>
      <tbody class="table-responsive">
        <% i=1 %>
        <% @tasks.each do |task| %>
          <tr id=<%="#{task.id}"%>>
            <td class="number">
              <p> <%= i %> </p>
              <% i += 1 %>
            </td>
            <td class='editable-field' name='name'>
              <%= task.name.html_safe if task.name%>
            </td>
            <td class='editable-field' name='source'>
              <%= task.source.html_safe if task.source %>
            </td>
            <td class='editable-field' name='skype'>
              <%= task.skype.html_safe if task.skype %>
            <td class='editable-field' name='email'>
              <%= task.email.html_safe if task.email %>
            </td>
            <td class="message">
              <div> <%= task.message.last.body %> </div>
            </td>
            <td class='links editable-field' name='links'>
              <%= task.links.html_safe if task.links %>
            </td>
            <td class="date">
              <input class="date-input" name="date" value='<%= task.date  %>'/> 
            </td>
            <td class='user_name'>
                <%= select("task", "user_id", User.all.collect {|p| [ p.first_name + ' ' + p.last_name , p.id ] }, { include_blank: "Not assigned", selected: task.user_id }, class: "btn btn-default user", name: 'user_id') %>
            </td>
            <td class='status'>
                <%= select_tag "Status", options_for_select(Task.status.options, task.status), class: "btn btn-default status", name: 'status' %>
            </td>
            <% if params[:only] == 'sold' %>
              <td class='price' name='price'>
                <div> <%= task.sold_task.price %> </div>
                <input hidden="true" class='id' value= <%="#{task.sold_task.id}"%> />
              </td>
              <td class='terms'>
                <label class='date_start' for='date_start'> Start: </label>
                <input class='date-input' value="<%= task.sold_task.date_start %> " name='date_start'/>
                <label class='date_end' for='date_end'> End: </label>
                <input class="date-input" value="<%= task.sold_task.date_end %>" name='date_end' />
                <input hidden="true" class='id' value= <%="#{task.sold_task.id}"%> />
              </td>
            <% end %>
            <td class='comments'>
              <div class="comment_list"> 
                <% task.comments.order(:created_at).each do |comment| %>
                  <div class="comment <%= comment.id %>">
                    <span class="comment_time"><%= comment.datetime.strftime('%e.%m %H:%M') %></span>
                    <span><%= comment.user.first_name %></span>
                    <% if comment.user == current_user %>
                      <%= link_to image_tag('remove-red.png'), comment, class: 'pull-right', remote: true, 
                        method: :delete  %> 
                    <% end %>
                    <p><%= comment.body.html_safe %></p>
                  </div>
                <% end %> 
              </div>
            </td>
            <td class="remove"> 
              <%= link_to image_tag('remove.png'), task, data: {
                  confirm: "Are you sure to destroy task №#{i-1}?"
                }, 
                method: :delete %> 
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    
    <% unless params[:only] %>
      <%= form_for Task.new do |f| %>
        <%= f.text_field :name, hidden: true %> 
        <%= f.submit "Add new task", class: "btn btn-primary btn-lg pull-right" %>
      <% end %>
    <% end %>

    <!-- Hidden blocks for popup dialogs -->
    <div id='common-dialog'> 
      <textarea id="text-editor"></textarea>
    </div>   

    <div id="comments_dialog" >
      <textarea id="comment_body" class="comment_body"></textarea>
      <button class="btn btn-primary btn-xs pull-right comment_save", type="button">Add new comment</button>
    </div>

    <div id="declined-comment">
      <textarea id="declined_comment_body" class="comment_body"></textarea>
    </div><!-- /.modal -->

    <div id="price-dialog" title="Price">
      <input id="price" type="number" class="price"/>
    </div><!-- /.modal -->

    <!-- End hidden blocks -->

  </div><!-- /main-content col-md-12 -->
</div> <!-- /row -->
